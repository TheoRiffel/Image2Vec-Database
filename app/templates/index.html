<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <link rel="stylesheet" href={{ url_for("static", filename = '/styles.css') }}>
    <title>Image Search</title>
</head>
<body>
    <h1>Envie sua imagem</h1>
    <section class="upload">
        <div class="container">
            <div id="preview">
                <p><strong>Imagem:</strong></p>
                <img id="imagePreview" src="" alt="Pré-visualização" width="226" max-width="100%" style="display: none;">
            </div>

            <form method="POST" enctype="multipart/form-data" id="sendImage">
                <input type="file" name="image" id="inputImage" accept="image/*" capture="environment" required><br>
                <p><label for="selectTabela">Tabela:</label>
                <select name="Tabela" id="selectTabela">
                    <option value="img_pgvector">pgvector</option>
                    <option value="img_pgarray">array</option>
                </select> </p>
                <p><label for="selectOperador">Operador:</label>
                <select name="Operador" id="selectOperador">
                    <option value="<+>">L1</option>
                    <option value="<->">L2</option>
                    <option value="<=>" selected>Cosine</option>
                    <option value="<#>">Inner product</option>
                </select> </p>
                <p><label for="selectCountry">Pais:</label>
                <select name="Pais" id="selectCountry">
                    <option value="" selected></option>
                </select> </p>
                <p><label for="selectRegion">Regiao:</label>
                <select name="Regiao" id="selectRegion">
                    <option value="" selected></option>
                </select> </p>
                <p><label for="income">Renda:</label>
                <input type="text" id="amount" readonly style="border:0; color:#f6931f; font-weight:bold;"></p>
                <div id="slider-range"></div>
                <button type="submit" id="getImages" name="getImages" value="getImages"> Obter Imagens </button>
                <button type="submit" id="getAnalysis" name="getAnalysis" value="getAnalysis"> Analisar Consulta </button>
            </form>
        </div>
    </section>
    
    <section class="view">
        <h2> Resultado </h2>
        <div id="result"> 
        </div>
        <div class="loader" style="display: none;" id="loader"></div>
        <div id="images_list">         
        </div>
    </section>
    

    <script>
        $(function () {
            $("#slider-range").slider({
                range: true,
                min: 0,
                max: 500,
                values: [75, 300],
                slide: function (event, ui) {
                $("#amount").val("$" + ui.values[0] + " - $" + ui.values[1]);
                }
            });

            $("#amount").val(
                "$" + $("#slider-range").slider("values", 0) +
                " - $" + $("#slider-range").slider("values", 1)
            );
        });
        $(document).ready(function() {
            document.getElementById("getImages").disabled = true; 
            document.getElementById("getAnalysis").disabled = true; 
            $.ajax({
                type: 'GET',
                url: '/metadata',
                processData: false,  
                contentType: false,
                success: function(response) {
                    response.countries.forEach(pais => {
                        var resp = "<option value='"+pais+"'>"+pais+"</option>"
                        $("#selectCountry").append(resp);
                    });
                    response.regions.forEach(regiao => {
                        var resp = "<option value='"+regiao+"'>"+regiao+"</option>"
                        $("#selectRegion").append(resp);
                    });

                    const min_income = Number(response.min_income)
                    const max_income = Number(response.max_income)

                    $("#slider-range").slider({
                        range: true,
                        min: min_income,
                        max: max_income,
                        values: [max_income/3 , max_income/2],
                        slide: function (event, ui) {
                        $("#amount").val("$" + ui.values[0] + " - $" + ui.values[1]);
                        }
                    });

                    $("#amount").val(
                        "$" + $("#slider-range").slider("values", 0) +
                        " - $" + $("#slider-range").slider("values", 1)
                    );
                    document.getElementById("getImages").disabled = false; 
                    document.getElementById("getAnalysis").disabled = false; 
                }
            });
        });

        $('#sendImage button[type=submit]').on('click', function () {
            acao = $(this).val();
        });

        $(document).on("submit", "#sendImage", function (e) {
            e.preventDefault();
            $("#images_list").empty();
            $("#result").empty();
            document.getElementById("getImages").disabled = true;
            document.getElementById("getAnalysis").disabled = true; 
            document.getElementById("loader").style.display="block";
            
            let form = document.getElementById('sendImage');
            let formData = new FormData(form);

            formData.append('acao', acao);
            
            $.ajax({
                type: "POST",
                url: "/upload",
                data: formData,
                processData: false,  
                contentType: false,  
                success: function (response) {
                    if (response.query_analysis){
                        console.log(response.query_analysis)
                        response.query_analysis.forEach(element => {
                                
                        console.log(element[0])
                        });
                    }

                    if (response.error){
                        var resp = "<p> <span id='notFound'> <strong> "+response.error+"</strong> </span> </p>"
                        $("#result").html(resp);
                    }
                    else if (response.images_path){
                        var result = "<p> Tempo de consulta: <span id='query_time_value'>" + response.query_time +"</span> s</p>"
                        $("#result").html(result);
                        response.images_path.forEach(element => {
                                
                            var resp = "<img class='image_result' src= '"+element+"' width='240'>"
                            $("#images_list").append(resp);
                        });
                    }   
                    
                      
                    document.getElementById("getImages").disabled = false;  
                    document.getElementById("getAnalysis").disabled = false; 
                    document.getElementById("loader").style.display = "none";             
                },
            });

        });

        $(document).on("change", "#inputImage", function () {
            const imagemPreview = document.getElementById('imagePreview');

            const file = this.files[0];
            if (file) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    imagemPreview.src = e.target.result;
                    imagemPreview.style.display = 'block';
                };

                reader.readAsDataURL(file);
            }
        });
    </script>
</body>
</html>